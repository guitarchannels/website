<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<meta http-equiv="X-UA-Compatible" content="IE=edge"/>
	<meta name="viewport" content="width=device-width, initial-scale=1, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" />
	<meta name="description" content="{{ head.description }}">
	<meta name="keywords" content="sailing,channels,youtube,sailboat,liveaboard,sail" />
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link rel="apple-touch-icon" href="{{staticPath}}/img/apple-touch-icon-60x60.png">
	<link rel="icon" type="image/png" href="{{staticPath}}/img/favicon-32x32.png" sizes="32x32">
	<link rel="icon" type="image/png" href="{{staticPath}}/img/android-chrome-192x192.png" sizes="192x192">
	<link rel="icon" type="image/png" href="{{staticPath}}/img/favicon-96x96.png" sizes="96x96">
	<link rel="icon" type="image/png" href="{{staticPath}}/img/favicon-16x16.png" sizes="16x16">
	<link rel="manifest" href="{{staticPath}}/img/manifest.json">
	<link rel="mask-icon" href="{{staticPath}}/img/safari-pinned-tab.svg" color="#5bbad5">
	<link rel="shortcut icon" href="{{staticPath}}/img/favicon.ico">
	<meta name="msapplication-TileColor" content="#da532c">
	<meta name="msapplication-TileImage" content="{{staticPath}}/img/mstile-144x144.png">
	<meta name="msapplication-config" content="{{staticPath}}/img/browserconfig.xml">
	<meta name="theme-color" content="#ffffff">
	<title>Sailing Channels</title>
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
	<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome-animation/0.0.9/font-awesome-animation.min.css">
	<style type="text/css">
    	#windyty {
			height: 100%;
			width: 100%;
		}

		.red {
			color:red;
		}

		#live {
			position:absolute;
			top:20px;
			left:20px;
			z-index: 999999999;
			padding:5px 8px;
			background-color:rgba(255,255,255,0.2);
			border-radius: 5px;
		}
    </style>
</head>
<body>
	<div id="live" style="display:none;">
		<i class="fa fa-circle faa faa-flash animated red" aria-hidden="true"></i> LIVE
	</div>
	<div id="windyty"></div>

	<script src="{{staticPath}}/js/vendor.js"></script>
	<script type="text/javascript">

    	var windytyInit = {
			// Required: API key
			key: "WAgdzv8AVSsdPqH",

			// Optional: Initial state of the map
			lat: 50.4,
			lon: 14.3,
			zoom: 6
      	};

		function getParameterByName(name, url) {
		    if (!url) url = window.location.href;
		    name = name.replace(/[\[\]]/g, "\\$&");
		    var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
		        results = regex.exec(url);
		    if (!results) return null;
		    if (!results[2]) return '';
		    return decodeURIComponent(results[2].replace(/\+/g, " "));
		}

		// Required: Windyty main function is called after
		// initialization of API
		//
		// @map is instance of Leaflet maps
		//
		function windytyMain(map) {

			map.addLayer(L.tileLayer("//{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
				attribution: '&copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>',
				maxZoom: 18,
				minZoom: 12
			}));

			// add seamarker layers
			map.addLayer(L.tileLayer("//sailing-channels.com/seamark/{z}/{x}/{y}.png", {
				maxZoom: 18,
				minZoom: 12
			}));

			var marker = null;
			var polyline = null;

			// load channel information
			var channel = getParameterByName("channel");

			var loadPosition = function() {

				// get channel information (incl. position)
				$.getJSON("/api/channel/get/" + channel, function(data) {

					var crs = data.vesselinfo.course || 0;
					var spd = data.vesselinfo.speed || 0;

					// show hide the live indicator
					if(spd > 0) $("#live").show();
					else $("#live").hide();

					// create or update marker
					if(marker) {
						marker.setHeading(crs);
						marker.setLatLng(data.position);
					}
					else {
						marker = L.boatMarker(data.position, {
						    "color": data.boatcolor || "#f1c40f"
						});

						marker.addTo(map);
					}

					var pup = "<table border='0'>";
					pup += "<tr><td><b>Name:</b></td><td>" + data.vesselinfo.name + "</td></tr>";

					var coded_src = "";
					switch(data.positionsource) {
						case "mmsi": coded_src = "AIS"; break;
						case "inreach": coded_src = "DeLorme inReach"; break;
					}

					pup += "<tr><td><b>Device:</b></td><td>" + coded_src + "</td></tr>";
					pup += "<tr><td><b>Course:&nbsp;</b></td><td>" + parseInt(crs) + "Â°</td></tr>";
					pup += "<tr><td><b>Speed:</b></td><td>" + spd.toFixed(1) + " kn</td></tr>";

					if("time" in data.vesselinfo && data.vesselinfo.time) {
						pup += "<tr><td><b>Received:</b></td><td>" + $.timeago(new Date(data.vesselinfo.time * 1000)) + "</td></tr>";
					}

					marker.bindPopup(pup);

					// more information available?
					if(data.vesselinfo) {

						// name the boat
						if(data.vesselinfo.name) marker.bindLabel(data.vesselinfo.name, { noHide: true });

						// set heading
						marker.setHeading(crs);
					}

					map.setView(data.position, 9);

					// fetch trail
					$.getJSON("/api/positions/" + channel + "/last/100", function(data) {

						if(data) {

							// filter out coords
							var coords = data.map(function(item) {
								return {
									"lat": item.pos[0],
									"lng": item.pos[1]
								};
							});

							if(coords.length > 0) {

								// add polyline to map
								if(polyline) {
									polyline.setLatLngs(coords);
								}
								else {
									polyline = L.polyline(coords, {
										color: "black"
									}).addTo(map);
								}
							}
						}
					});
				});

			};

			// update every x seconds
			window.setInterval(loadPosition, 10000);
			loadPosition();
		}

    </script>
    <script async defer src="//api.windyty.com/v2.1/boot.js"></script>
	<script>
	  (function(i,s,o,g,r,a,m){i["GoogleAnalyticsObject"]=r;i[r]=i[r]||function(){
	  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
	  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
		})(window,document,"script","//www.google-analytics.com/analytics.js","ga");

	  ga("create", "UA-15981085-17", "auto");
	  ga("send", "pageview");
	  ga("send", "event", "Map", "View", location.href, {
	 	nonInteraction: true
	  });
	</script>
	<link rel="stylesheet" href="//maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css">
</body>
</html>
